<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üìû EMI Reminder Voice Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>üìû EMI Reminder Voice Agent</h1>
        <p>Upload an Excel file with columns: <b>Name,</b> <b>Phone</b> and <b>Language</b>.</p>
        <form action="/trigger-calls" method="post" enctype="multipart/form-data">
            <input type="file" name="file" accept=".xlsx" required><br>
            <button type="submit">Trigger Calls</button>
        </form>

        {% if result %}
            <div class="output">
                <h3>Logs:</h3>
                <div class="log-box">{{ result | replace('\n', '<br>') | safe }}</div>
                <a href="/download-report" class="download">üì• Download Call Status Excel</a>
            </div>
        {% endif %}
    </div>
</body>
</html> -->

<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üìû EMI Reminder Voice Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        function enableScheduleButton() {
            document.getElementById('scheduleBtn').disabled = false;
        }

        function showTimeBox() {
            console.log("showTimeBox called");
            const timeBox = document.getElementById('timeBox');
            console.log("timeBox element:", timeBox);
            timeBox.style.display = 'block';
            console.log("Display changed to block");
        }

        async function scheduleCall() {
            const timeInput = document.getElementById('scheduleTime').value;
            if (!timeInput) {
                alert("Please select a time first!");
                return;
            }

            const [hour, minute] = timeInput.split(':').map(Number);
            try {

                // ‚úÖ Hide output section BEFORE making the API call
                const outputDiv = document.querySelector('.output');
                if (outputDiv) {
                    outputDiv.style.display = 'none';
                }

                const res = await fetch(`/schedule-call?hour=${hour}&minute=${minute}`);
                const data = await res.json();

                document.getElementById('message').innerHTML = 
                    `‚úÖ ${data.message}<br>üìß The status report will be sent to your email.`;

                // // Disable download button if scheduled
                // const downloadBtn = document.getElementById('downloadBtn');
                // if (downloadBtn) downloadBtn.classList.add('disabled');
                // ‚úÖ Hide logs and download section when scheduling
                // const outputDiv = document.querySelector('.output');
                // if (outputDiv) {
                //     outputDiv.style.display = 'none';
                // }

            } catch (err) {
                alert("‚ùå Failed to schedule calls: " + err.message);
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>üìû EMI Reminder Voice Agent</h1>
        <p>Upload an Excel file with columns: <b>Name,</b> <b>Phone</b> and <b>Language</b>.</p>

        <form id="uploadForm" action="/trigger-calls" method="post" enctype="multipart/form-data">
            <input type="file" name="file" accept=".xlsx" required onchange="enableScheduleButton()"><br>
            <button type="submit">Trigger Calls</button>
        </form>

        <button id="scheduleBtn" onclick="showTimeBox()" disabled>üìÖ Schedule Calls</button>

        <div id="timeBox" style="display:none; margin-top:20px;">
            <label for="scheduleTime"><b>Select Time (IST):</b></label><br>
            <input type="time" id="scheduleTime" required>
            <button onclick="scheduleCall()">Confirm Schedule</button>
        </div>

        <div id="message" style="margin-top:20px; color:green; font-weight:bold;"></div>

        {% if result %}
        <div class="output">
            <h3>Logs:</h3>
            <div class="log-box">{{ result | replace('\n', '<br>') | safe }}</div>
            <a id="downloadBtn" href="/download-report" class="download">üì• Download Call Status Excel</a>
        </div>
        {% endif %}
    </div>
</body>
</html> -->


<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìû EMI Reminder Voice Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        function enableScheduleButton() {
            document.getElementById('scheduleBtn').disabled = false;
        }

        function showTimeBox() {
            const timeBox = document.getElementById('timeBox');
            const scheduleBtn = document.getElementById('scheduleBtn');
            
            if (timeBox.style.display === 'none' || timeBox.style.display === '') {
                timeBox.style.display = 'block';
                scheduleBtn.textContent = '‚ùå Cancel Schedule';
            } else {
                timeBox.style.display = 'none';
                scheduleBtn.textContent = 'üìÖ Schedule Calls';
            }
        }

        async function scheduleCall() {
            // Hide output section BEFORE making the API call
            const outputDiv = document.querySelector('.output');
            if (outputDiv) {
                outputDiv.style.display = 'none';
            }

            const timeInput = document.getElementById('scheduleTime').value;
            if (!timeInput) {
                alert("Please select a time first!");
                return;
            }

            const [hour, minute] = timeInput.split(':').map(Number);
            
            // Show loading state
            const confirmBtn = event.target;
            const originalText = confirmBtn.textContent;
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Scheduling...';
            
            try {
                // // Hide output section BEFORE making the API call
                // const outputDiv = document.querySelector('.output');
                // if (outputDiv) {
                //     outputDiv.style.display = 'none';
                // }

                const res = await fetch(`/schedule-call?hour=${hour}&minute=${minute}`);
                const data = await res.json();

                document.getElementById('message').innerHTML = 
                    `‚úÖ ${data.message}<br>üìß The status report will be sent to your email.`;
                
                // Hide time box after successful scheduling
                document.getElementById('timeBox').style.display = 'none';
                document.getElementById('scheduleBtn').textContent = 'üìÖ Schedule Calls';

            } catch (err) {
                alert("‚ùå Failed to schedule calls: " + err.message);
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
            }
        }

        // Reset message when uploading new file
        function handleFileUpload() {
            enableScheduleButton();
            document.getElementById('message').innerHTML = '';
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>üìû EMI Reminder Voice Agent</h1>
        <p class="subtitle">Upload an Excel file with columns: <b>Name</b>, <b>Phone</b>, and <b>Language</b></p>

        <div class="upload-section">
            <form id="uploadForm" action="/trigger-calls" method="post" enctype="multipart/form-data">
                <div class="file-input-wrapper">
                    <input type="file" name="file" id="fileInput" accept=".xlsx" required onchange="handleFileUpload()">
                    <label for="fileInput" class="file-label">
                        üìÅ Choose Excel File
                    </label>
                    <span id="fileName" class="file-name"></span>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">
                        üöÄ Trigger Calls Now
                    </button>
                    <button type="button" id="scheduleBtn" class="btn btn-secondary" onclick="showTimeBox()" disabled>
                        üìÖ Schedule Calls
                    </button>
                </div>
            </form>
        </div>

        <div id="timeBox" class="time-box">
            <h3>‚è∞ Schedule Call Time</h3>
            <div class="time-input-group">
                <label for="scheduleTime">Select Time (IST):</label>
                <input type="time" id="scheduleTime" required>
                <button onclick="scheduleCall()" class="btn btn-confirm">Confirm Schedule</button>
            </div>
        </div>

        <div id="message" class="message-box"></div>

        {% if result %}
        <div class="output">
            <div class="log-box">{{ result | replace('\n', '<br>') | safe }}</div>
            <a id="downloadBtn" href="/download-report" class="btn btn-download">
                üì• Download Call Status Report
            </a>
        </div>
        {% endif %}

    </div>

    <script>
        // Show selected filename
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || '';
            const fileNameSpan = document.getElementById('fileName');
            if (fileName) {
                fileNameSpan.textContent = fileName;
                fileNameSpan.style.display = 'inline';
            }
        });
    </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìû EMI Reminder Voice Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        function enableScheduleButton() {
            document.getElementById('scheduleBtn').disabled = false;
        }

        function showTimeBox() {
            const timeBox = document.getElementById('timeBox');
            const scheduleBtn = document.getElementById('scheduleBtn');
            const downloadSection = document.getElementById('downloadSection');
            const message = document.getElementById('message')

            if (timeBox.style.display === 'none' || timeBox.style.display === '') {
                timeBox.style.display = 'block';
                scheduleBtn.textContent = '‚ùå Cancel Schedule';
                if (message) {
                    message.style.display = 'none'
                }
                if (downloadSection) {
                    downloadSection.style.display = 'none';
                }
            } else {
                timeBox.style.display = 'none';
                scheduleBtn.textContent = 'üìÖ Schedule Calls';
            }
        }

        async function scheduleCall() {
            const timeInput = document.getElementById('scheduleTime').value;
            if (!timeInput) {
                alert("Please select a time first!");
                return;
            }

            const [hour, minute] = timeInput.split(':').map(Number);
            
            // Show loading state
            const confirmBtn = event.target;
            const originalText = confirmBtn.textContent;
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Scheduling...';
            
            try {
                const res = await fetch(`/schedule-call?hour=${hour}&minute=${minute}`);
                const data = await res.json();
                const downloadSection = document.getElementById('downloadSection');
                if (downloadSection) {
                    downloadSection.style.display = 'none';
                }

                document.getElementById('message').innerHTML = 
                    `‚úÖ ${data.message}<br>üìß The status report will be sent to your email.`;
                document.getElementById('message').className = 'message-box success';
                
                // Hide time box after successful scheduling
                document.getElementById('timeBox').style.display = 'none';
                document.getElementById('scheduleBtn').textContent = 'üìÖ Schedule Calls';

            } catch (err) {
                document.getElementById('message').innerHTML = `‚ùå Failed to schedule calls: ${err.message}`;
                document.getElementById('message').className = 'message-box error';
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
            }
        }

        async function triggerCalls(event) {
            event.preventDefault();
            
            const form = event.target;
            const fileInput = form.querySelector('input[type="file"]');
            const submitBtn = form.querySelector('button[type="submit"]');
            
            if (!fileInput.files[0]) {
                alert("Please select a file first!");
                return;
            }

            // Show loading state
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Triggering Calls...';

            const formData = new FormData(form);

            try {
                const response = await fetch('/trigger-calls', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('message').innerHTML = `‚úÖ ${data.message}`; 
                    document.getElementById('message').className = 'message-box success';
                    
                    // Show download button after a delay
                    // setTimeout(() => {
                    //     document.getElementById('downloadSection').style.display = 'block';
                    // }, 60000); // Show after 1 minute
                    document.getElementById('downloadSection').style.display = 'block';
                } else {
                    document.getElementById('message').innerHTML = `‚ùå ${data.error || 'Failed to trigger calls'}`;
                    document.getElementById('message').className = 'message-box error';
                }

            } catch (err) {
                document.getElementById('message').innerHTML = `‚ùå Error: ${err.message}`;
                document.getElementById('message').className = 'message-box error';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // Reset message when uploading new file
        function handleFileUpload() {
            enableScheduleButton();
            document.getElementById('message').innerHTML = '';
            document.getElementById('message').className = 'message-box';
            document.getElementById('downloadSection').style.display = 'none';
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>üìû EMI Reminder Voice Agent</h1>
        <p class="subtitle">Upload an Excel file with columns: <b>Name</b>, <b>Phone</b>, and <b>Language</b></p>

        <div class="upload-section">
            <form id="uploadForm" onsubmit="triggerCalls(event)" enctype="multipart/form-data">
                <div class="file-input-wrapper">
                    <input type="file" name="file" id="fileInput" accept=".xlsx" required onchange="handleFileUpload()">
                    <label for="fileInput" class="file-label">
                        üìÅ Choose Excel File
                    </label>
                    <span id="fileName" class="file-name"></span>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">
                        üöÄ Trigger Calls Now
                    </button>
                    <button type="button" id="scheduleBtn" class="btn btn-secondary" onclick="showTimeBox()" disabled>
                        üìÖ Schedule Calls
                    </button>
                </div>
            </form>
        </div>

        <div id="timeBox" class="time-box">
            <h3>‚è∞ Schedule Call Time</h3>
            <div class="time-input-group">
                <label for="scheduleTime">Select Time (IST):</label>
                <input type="time" id="scheduleTime" required>
                <button onclick="scheduleCall()" class="btn btn-confirm">Confirm Schedule</button>
            </div>
        </div>

        <div id="message" class="message-box"></div>

        <div id="downloadSection" class="download-section" style="display:none;">
            <h3>üìä Download Report</h3>
            <p>Your calls have been processed. The status report will be sent to your email. For live status, download the status report below:</p>
            <a href="/download-report" class="btn btn-download">
                üì• Download Call Status Report
            </a>
        </div>
    </div>

    <script>
        // Show selected filename
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || '';
            const fileNameSpan = document.getElementById('fileName');
            if (fileName) {
                fileNameSpan.textContent = fileName;
                fileNameSpan.style.display = 'inline';
            }
        });
    </script>
</body>
</html>